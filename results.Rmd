# Results

```{r}
# read in clean data

demo_df <- read.csv("data/clean/demo_df.csv")
us_by_year <- read.csv("data/clean/us_by_year.csv")
coverage_by_state <- read.csv("data/clean/coverage_by_state.csv")

library(ggthemes)
```

## Geographical Patterns

```{r}

library(choroplethr)

choropleth_df <-
  demo_df %>%
    select(c(state, flu_shot_coverage_2021)) %>%
    mutate(flu_shot_coverage_2021 = as.integer(flu_shot_coverage_2021)) %>%
    filter(state != "District of Columbia") %>%
    transmute(region = tolower(`state`),
           value =  flu_shot_coverage_2021)

states <- state_choropleth(choropleth_df,
                 title = "Flu Vaccine Coverage, 2021",
                 legend = "Percent Covered")

# remove state abbreviation labels
layer_no <- grep("GeomText", sapply(states$layers, function(x) class(x$geom)[1]))
states$layers[[layer_no]] <- NULL

states

```

## Flu Vaccination Coverage Time Series Patterns

```{r}
library(cowplot)

#lm <- lm(Estimate.... ~ as.Date(ym), data=us_by_year)

maximum <- us_by_year %>% filter(str_detect(ym, ".*-05-01"))
p1<- us_by_year %>%
  ggplot(aes(as.Date(ym), Estimate....)) +
    geom_line(group = 1) +
    scale_x_date(date_breaks = "years" , date_labels = "%Y") + 
    xlab("") + 
    ylab("Percent Coverage\n [%]") +
    geom_line(data=maximum, aes(x=as.Date(maximum$ym), y=maximum$Estimate...., ), color ="red")+
    ggtitle("Flu Shot Coverage, 2009 to 2022")+
  scale_color_colorblind()  

p2 <- us_by_year %>%
  ggplot(aes(as.Date(ym), Estimate....)) +
    geom_smooth(group = 1) +
    scale_x_date(date_breaks = "years" , date_labels = "%Y") + 
    xlab("") + 
    ylab("Percent Coverage\n [%]") +
    ggtitle("Flu Shot Coverage, 2009 to 2022")+
  scale_color_colorblind()  

cowplot::plot_grid(
  p1, p2,
  labels = "AUTO", ncol = 1
)

```

## Demographical Patterns

### Races and Age Groups: 2021

```{r}
library(forcats)
flu <- read.csv("./data/clean/flu.csv")
flu_race<- flu %>% filter(Dimension.Type == "Race/Ethnicity (age ≥6 months only)",
                          Geography.Type == "HHS Regions/National",
                          Geography == "United States",
                          str_detect(ym, "2021-05-01")) %>% mutate(ym = as.Date(ym))%>% arrange(ym)
flu_race$Dimension <- fct_reorder(flu_race$Dimension, flu_race$Estimate....)
race<-ggplot(data=flu_race)+
  geom_bar(aes(x=	flu_race$Dimension, y=flu_race$Estimate....),stat="identity", fill="skyblue1",alpha=0.7)+
  labs(x="Race", y="Flu Vaccination Coverage Rate 2021 [%]", title="Flu Vaccination Coverage Rate 2021 by race")+
  coord_flip()+
  scale_color_colorblind()  

flu_age<- flu %>% filter(Dimension.Type == "Age",
                          !str_detect(Dimension, "≥6"),
                          Geography.Type == "HHS Regions/National",
                          Geography == "United States",
                          str_detect(ym, "2021-05-01")) %>%
                  filter(Dimension %in% c("6 Months - 4 Years",
                                          "5-12 Years",
                                          "13-17 Years",
                                          "18-64 Years")) %>%
                  mutate(ym = as.Date(ym))%>% arrange(ym)

flu_age$Dimension <- fct_reorder(flu_age$Dimension, flu_age$Estimate....)
age<-ggplot(data=flu_age)+
  geom_bar(aes(x=	flu_age$Dimension, y=flu_age$Estimate....),stat="identity", fill="skyblue1",alpha=0.7)+
  labs(x="Age Groups", y="Flu Vaccination Coverage Rate 2021 [%]", title="Flu Vaccination Coverage Rate 2021 by Age Group")+
  coord_flip()+
  scale_color_colorblind()  

gridExtra::grid.arrange(race,age,nrow=2)
```

### Races and Age Groups: A Time Series Analysis

```{r}
flu_race_ts <- flu %>% filter(Vaccine == "Seasonal Influenza",
                          Dimension.Type == "Race/Ethnicity (age ≥6 months only)",
                          Geography.Type == "HHS Regions/National",
                          !Dimension %in% c("≥6 months Asian, Non-Hispanic","≥6 months American Indian or Alaska Native, Non-Hispanic"),
                          Geography == "United States",
                          str_detect(ym, ".*-05-01")) %>% mutate(ym = as.Date(ym))%>% arrange(ym)

ggplot(data=flu_race_ts)+
  geom_line(aes(x=ym,y=flu_race_ts$Estimate....))+
  facet_wrap(.~Dimension)+
  labs(x="Year", y="Flu Vaccination Coverage Rate\n [%]",title = "Flu Vaccination Coverage Rate by Race, 2009-2021")+
  scale_color_colorblind()  


```

```{r}

flu_age_ts <- flu %>% filter(Vaccine == "Seasonal Influenza",
                          Dimension.Type == "Age",
                          !str_detect(Dimension, "≥6"),
                          Geography.Type == "HHS Regions/National",
                          Geography == "United States",
                          str_detect(ym, ".*-05-01")) %>% 
                        filter(Dimension %in% c("6 Months - 4 Years",
                                          "5-12 Years",
                                          "13-17 Years",
                                          "18-64 Years")) %>%mutate(ym = as.Date(ym))%>% arrange(ym)
flu_age_ts$Dimension <- factor(flu_age_ts$Dimension, levels = c("6 Months - 4 Years",
                                          "5-12 Years",
                                          "13-17 Years",
                                          "18-64 Years"))
ggplot(data=flu_age_ts)+
  geom_line(aes(x=ym,y=flu_age_ts$Estimate....))+
  facet_wrap(.~Dimension)+
  labs(x="Year", y="Flu Vaccination Coverage Rate\n[%]
       ",title = "Flu Vaccination Coverage Rate by Age Group, 2009-2021")+
  scale_color_colorblind()  

```

### Other Demographics Data: Sorting Out Important Factors Using Biplots

```{r fig1, fig.height = 10, fig.width = 10}

remotes::install_github("jtr13/redav")
library(redav)

demo_df_biplot <-
  demo_df %>%
    select(c(state, household_poverty_rate, flu_shot_coverage_2021, household_wealth_rate, median_household_income, high_school_education_ratio, elder_ratio, children_ratio)) %>%
    mutate(across(where(is.numeric), ~round((.x-mean(.x))/sd(.x), 2)))

pca <- prcomp(demo_df_biplot[,2:4], scale. = TRUE)

draw_biplot(demo_df_biplot)


```

### Cleveland Dotplot of Most Important Factors

```{r}

demo_df %>%
  select(c(state, flu_shot_coverage_2021, high_school_education_ratio, household_poverty_rate)) %>%
  mutate(across(where(is.numeric), ~round((.x-mean(.x))/sd(.x), 2))) %>%
  gather(key='type',value='percentage',flu_shot_coverage_2021, high_school_education_ratio, household_poverty_rate) %>%
  ggplot(aes(x=percentage, y=fct_reorder2(state,type=='household_poverty_rate',percentage,.desc=FALSE), color = type)) +
    geom_point() +
    ggtitle("Flu Coverage, Education, and Poverty Rates in the US") +
    ylab("") +
    theme_linedraw()+
  scale_color_colorblind()



```

## Time Series Comparison of Nationanlwide New COVID Cases with Flu Vaccination Coverage

```{r}
covid2 <- read.csv("data/raw/United_States_COVID-19_Cases.csv")

covid2 <- covid2[-which(covid2$tot_cases == 0 |is.na(covid2$tot_cases)),]
covid2 <- covid2 %>% dplyr::select(submission_date, state, new_case)
covid_time2 <- group_by(covid2,submission_date)
new_cases <- summarize(covid_time2, sum(new_case))
new_cases <- rename(new_cases, new_covid_case='sum(new_case)')
new_cases$submission_date <- as.Date(new_cases$submission_date, format = "%m/%d/%Y")
new_cases <- arrange(new_cases,submission_date)

library(scales)

g<-ggplot(new_cases, aes(submission_date, new_covid_case)) + 
  geom_smooth(method = "loess", span = .05, se = FALSE)+
  scale_x_date(limits = c(as.Date("2018-01-01"),as.Date("2021-12-01")))+
  scale_y_continuous(labels = scales::label_number_si())+
  labs(y="Count", title="Nationalwide New Covid Cases")+
  scale_color_colorblind()
  
coverage_rate <- rename(us_by_year, estimation='Estimate....',record_date='ym')
coverage_rate$difference_with_previous_month <- append(NA,diff(coverage_rate$estimation))
coverage_rate$difference_with_previous_month[coverage_rate$difference_with_previous_month<0]<-0
coverage_rate$record_date <- as.Date(coverage_rate$record_date)


# f<-ggplot(coverage_rate, aes(record_date, difference_with_previous_month)) + 
#   geom_smooth(method = "loess", span = .1, se = FALSE)+
#   scale_x_date(limits = c(as.Date("2018-01-01"),as.Date("2021-12-01")))+
#   labs(y="Percentage increase", title="Increase in Nationalwide Flu Vax Coverage Compared to Previous Months (%)")+
#   scale_color_colorblind()


coverage_rate$record_date <- as.Date(coverage_rate$record_date)


h<-ggplot(coverage_rate, aes(record_date, estimation)) + 
  geom_smooth(method = "loess", span = .1, se = FALSE)+
  scale_x_date(limits = c(as.Date("2018-01-01"),as.Date("2021-12-01")))+
  labs(y="Coverage Rate", title = "Nationalwide Flu Vaccination Coverage Rate (%)")+
  scale_color_colorblind()

plot_grid(g,h, nrow=2,align = "v")
```




```{r}

# library(choroplethr)
# 
# choropleth_df <-
#   demo_df %>%
#     select(c(state, household_poverty_rate)) %>%
#     mutate(household_poverty_rate = as.numeric(household_poverty_rate)) %>%
#     filter(state != "District of Columbia") %>%
#     transmute(region = tolower(`state`),
#            value =  household_poverty_rate)
# 
# states <- state_choropleth(choropleth_df,
#                  title = "Household Poverty Rate, 2021",
#                  legend = "Percent")
# 
# # remove state abbreviation labels
# layer_no <- grep("GeomText", sapply(states$layers, function(x) class(x$geom)[1]))
# states$layers[[layer_no]] <- NULL
# 
# states

```

```{r}


# us_by_year %>%
#   filter(Season.Survey.Year == "2021-22") %>%
#   ggplot(aes(factor(Month), Estimate....)) +
#     geom_line(group = 1) +
#     # scale_x_date(limits = c(as.Date("2012-02-01"), as.Date("2014-12-31")),  
#     #     date_breaks = "6 months", date_labels = "%b %Y") 
#     # scale_x_date(date_breaks = "years" , date_labels = "%Y") + 
#     xlab("Month") + 
#     ylab("Percent Coverage") +
#     ggtitle("Flu Shot Coverage, 2021 to 2022")


```