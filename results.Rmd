# Results

```{r}
# read in clean data

demo_df <- read.csv("data/clean/demo_df.csv")
us_by_year <- read.csv("data/clean/us_by_year.csv")
coverage_by_state <- read.csv("data/clean/coverage_by_state.csv")

library(ggthemes)
```

## Geographical Patterns

First, we created a choropleth map using color to indicate the value of flu vaccine coverage rate within United States by state for 2021 and check if there exist some geographical patterns for the distribution of flu vaccine coverage rate.

```{r}
library(dplyr)
library(tidyverse)
library(choroplethr)

choropleth_df <-
  demo_df %>%
    select(c(state, flu_shot_coverage_2021)) %>%
    mutate(flu_shot_coverage_2021 = as.integer(flu_shot_coverage_2021)) %>%
    filter(state != "District of Columbia") %>%
    transmute(region = tolower(`state`),
           value =  flu_shot_coverage_2021)

states <- state_choropleth(choropleth_df,
                 title = "Flu Vaccine Coverage, 2021",
                 legend = "Percent Covered")

# remove state abbreviation labels
layer_no <- grep("GeomText", sapply(states$layers, function(x) class(x$geom)[1]))
states$layers[[layer_no]] <- NULL

states

```
We noticed that the areas with high vaccine coverage are mainly in the Midwest, Northeast and Mid-Atlantic regions of the United States. According to a CDC report, flu season usually occurs in the fall and winter in the United States. While influenza viruses spread year-round, most of the time flu activity peaks are between December and February. Thus, low temperatures could be accompanied by high rates of flu infection and thus vaccine coverage rate. Looking at the US map above, Midwest states such as Colorado are located near the Rocky Mountains, with high altitude and low temperatures. The north has a high latitude and a lower temperature than the south. Due to factors such as ocean current and monsoon, the climate in the east is quite different from that in the west coast, and the temperature is relatively lower. Therefore, these regions have relatively higher coverage of flu vaccine. Thus, it appears that the distribution of flu vaccine coverage does have a geographical pattern.

Another explanation for this pattern could be patterns of political history. Southern states, leaning more right on the political spectrum, may be less inclined to get a flu shot, whereas Northeast states that tend to vote more liberally would do otherwise, which supports the distribution of coverage we see. We will continue to explore these geographic trends as our analysis continues.

## Flu Vaccination Coverage Time Series Patterns

Next, we performed a time series analysis on nationwide flu vaccination coverage from 2009 to 2022 using the clean us_by_year data mentioned in the data section. Notice that the flu vaccination coverage dataset gives the cumulative flu shot coverage from last July or August. For example, the coverage rate in 2021-03 is the overall coverage rate from 2020-07 to 2021-03. Also notice that the content of seasonal influenza changes every year, so every year there is a sudden drop in coverage rate (probably in June). The red line in plot A below shows the highest coverage rate of that year.

```{r}
library(cowplot)

#lm <- lm(Estimate.... ~ as.Date(ym), data=us_by_year)

maximum <- us_by_year %>% filter(str_detect(ym, ".*-05-01"))
p1<- us_by_year %>%
  ggplot(aes(as.Date(ym), Estimate....)) +
    geom_line(group = 1) +
    scale_x_date(date_breaks = "years" , date_labels = "%Y") + 
    xlab("") + 
    ylab("Percent Coverage\n [%]") +
    geom_line(data=maximum, aes(x=as.Date(maximum$ym), y=maximum$Estimate...., ), color ="red")+
    ggtitle("Flu Shot Coverage, 2009 to 2022")+
  scale_color_colorblind()  

p2 <- us_by_year %>%
  ggplot(aes(as.Date(ym), Estimate....)) +
    geom_smooth(group = 1) +
    scale_x_date(date_breaks = "years" , date_labels = "%Y") + 
    xlab("") + 
    ylab("Percent Coverage\n [%]") +
    ggtitle("Flu Shot Coverage, 2009 to 2022")+
  scale_color_colorblind()  

cowplot::plot_grid(
  p1, p2,
  labels = "AUTO", ncol = 1
)

```

Based on the above two plots, one can observe that the overall trend of nationwide flu vaccination coverage rate is increasing (red line, which represents the overall coverage rate of that year), from about 42% in 2009 to about 52% in 2021. Notice there is a conspicuous drop in 2017, which corresponds to a [report](https://www.cidrap.umn.edu/influenza-general/review-severe-2017-18-flu-season-shows-drop-vaccination) by the University of Minnesota. And after 2017, we notice a more or less remarkable increase in flu vaccination rate. We will zoom into the 2018-2022 range in later sections to find its correlations with the COVID-19 pandemic. 

Speaking of the patterns for each year, from July or August the coverage rate quickly increases (concave up), and then slowly increases (concave down) from about December to April of the next year, which corresponds to our commonsense: those who want to take flu shots will do it as soon as the new flu shot releases, and fewer people will take flu shots before a new type of flu shot will come out in May or June.

## Demographical Patterns

Next we will relate flu vaccination coverage rates to demographical data.

### Races and Age Groups: 2021

We will look at the 2021 data (the latest flu data we have). We plot flu vaccination coverage rates with respect to race groups and age groups.

```{r}
library(forcats)
flu <- read.csv("./data/clean/flu.csv")
flu_race<- flu %>% filter(Dimension.Type == "Race/Ethnicity (age ≥6 months only)",
                          Geography.Type == "HHS Regions/National",
                          Geography == "United States",
                          str_detect(ym, "2021-05-01")) %>% mutate(ym = as.Date(ym))%>% arrange(ym)
flu_race$Dimension <- fct_reorder(flu_race$Dimension, flu_race$Estimate....)
race<-ggplot(data=flu_race)+
  geom_bar(aes(x=	flu_race$Dimension, y=flu_race$Estimate....),stat="identity", fill="skyblue1",alpha=0.7)+
  labs(x="Race", y="Flu Vaccination Coverage Rate 2021 [%]", title="Flu Vaccination Coverage Rate 2021 by race")+
  coord_flip()+
  scale_color_colorblind()  

flu_age<- flu %>% filter(Dimension.Type == "Age",
                          #!str_detect(Dimension, "≥6"),
                          Geography.Type == "HHS Regions/National",
                          Geography == "United States",
                          str_detect(ym, "2021-05-01")) %>%
                  filter(Dimension %in% c("6 Months - 4 Years",
                                          "5-12 Years",
                                          "13-17 Years",
                                          "18-64 Years",
                                          "≥6 Months")) %>%
                  mutate(ym = as.Date(ym))%>% arrange(ym)

flu_age$Dimension <- fct_reorder(flu_age$Dimension, flu_age$Estimate....)
age<-ggplot(data=flu_age)+
  geom_bar(aes(x=	flu_age$Dimension, y=flu_age$Estimate....),stat="identity", fill="skyblue1",alpha=0.7)+
  labs(x="Age Groups", y="Flu Vaccination Coverage Rate 2021 [%]", title="Flu Vaccination Coverage Rate 2021 by Age Group")+
  coord_flip()+
  scale_color_colorblind()  

gridExtra::grid.arrange(race,age,nrow=2)
```

For race groups, we see that for the year 2021, the white race group has the most flu vaccination coverage rate, reaching about 53%, with other races (unfortunately we cannot be more specific about which races it contains due to the limitation of the dataset) being the second most covered group, also reaching more than 50%; the Hispanic race group is the second least covered group, with coverage rate about 44%; the Black race group is the least covered group, with coverage rate a little less than the Hispanic race group. This kind of pattern of flu coverage with respect to race groups may be intertwined with other socio-economical phenomena.

Talking about age groups, if we use >= 6 months as a baseline group, we can see that the older the age group is, the less coverage rate that group gets. age groups with 13-17 years old and 18-64 years old are below the baseline coverage rates, and the coverage rates for 6 months- 4 years old and 5-12 years old groups are well above the baseline group coverage rate. We notice that children gets more flu vaccine coverage (reaching about 64%) than teenagers and adults, and that is probably due to the fact that children are more susceptible to seasonal influenza, as stated in this [article](https://www.mayoclinic.org/healthy-lifestyle/infant-and-toddler-health/expert-answers/flu-shots/faq-20058448), so they need flu vaccines to prevent complications. 



### Races and Age Groups: A Time Series Analysis

We do a time series analysis from 2009 to 2021 in race and age groups to see if there is some abnomalities similar to what we see in Simpson's Paradox.

```{r}
flu_race_ts <- flu %>% filter(Vaccine == "Seasonal Influenza",
                          Dimension.Type == "Race/Ethnicity (age ≥6 months only)",
                          Geography.Type == "HHS Regions/National",
                          !Dimension %in% c("≥6 months Asian, Non-Hispanic","≥6 months American Indian or Alaska Native, Non-Hispanic"),
                          Geography == "United States",
                          str_detect(ym, ".*-05-01")) %>% mutate(ym = as.Date(ym))%>% arrange(ym)

ggplot(data=flu_race_ts)+
  geom_line(aes(x=ym,y=flu_race_ts$Estimate....))+
  facet_wrap(.~Dimension)+
  labs(x="Year", y="Flu Vaccination Coverage Rate\n [%]",title = "Flu Vaccination Coverage Rate by Race, 2010-2021")+
  scale_y_continuous(limits = c(0,59))+
  scale_color_colorblind()  


```
We see that these race groups follow the same trend as the overall population, as we see in previous sections. We can observe that there are drops in flu vaccination coverage rates in the year 2017 in all four race groups. 

Notice that for the  White, Non-Hispanic group, the rebound (increase) after 2017 is stronger than other race groups (the rebound is about 13%, from ~42% in 2017 to ~55% in 2020). For Other or Multiple Races, the rebound is not as strong as the white race group; for Hispanic and Black race group, the rebound is even weaker; for the Hispanic race group, we can hardly see a pronounced increase in coverage rate post-2017 as compared to pre-2017.


```{r}

flu_age_ts <- flu %>% filter(Vaccine == "Seasonal Influenza",
                          Dimension.Type == "Age",
                          #!str_detect(Dimension, "≥6"),
                          Geography.Type == "HHS Regions/National",
                          Geography == "United States",
                          str_detect(ym, ".*-05-01")) %>% 
                        filter(Dimension %in% c("6 Months - 4 Years",
                                          "5-12 Years",
                                          "13-17 Years",
                                          "18-64 Years",
                                          "≥6 Months")) %>%mutate(ym = as.Date(ym))%>% arrange(ym)
flu_age_ts$Dimension <- factor(flu_age_ts$Dimension, levels = c("6 Months - 4 Years",
                                          "5-12 Years",
                                          "13-17 Years",
                                          "18-64 Years",
                                          "≥6 Months"))
ggplot(data=flu_age_ts)+
  geom_line(aes(x=ym,y=flu_age_ts$Estimate....))+
  facet_wrap(.~Dimension)+
  labs(x="Year", y="Flu Vaccination Coverage Rate\n[%]
       ",title = "Flu Vaccination Coverage Rate by Age Group, 2010-2021")+
  scale_y_continuous(limits = c(0,80))+
  scale_color_colorblind()  

```

The age groups time series pattern also follows the general pattern discussed before; moreover, it follows the 2021 age group pattern: generally speaking, the older ages the group contains, the less the flu rate coverage rate across years.

A pronounced point in these plots is that for 13-17 years group, the coverage rate is equal to or even lower than the 18-64 years group in 2010, but it increases in the following years and exceeds the coverage rate for 18-64 years group.

### Other Demographics Data: Sorting Out Important Factors Using Biplots

Next, we draw a biplot based on selected features from demo_df, demographical information in 2021 introduced in the data section, to examine correlations between demographical features and flu vaccination coverage.


```{r fig1, fig.height = 10, fig.width = 10}

remotes::install_github("jtr13/redav")
library(redav)

demo_df_biplot <-
  demo_df %>%
    select(c(state, household_poverty_rate, flu_shot_coverage_2021, household_wealth_rate, median_household_income, high_school_education_ratio, elder_ratio, children_ratio)) %>%
    mutate(across(where(is.numeric), ~round((.x-mean(.x))/sd(.x), 2)))

pca <- prcomp(demo_df_biplot[,2:4], scale. = TRUE)

draw_biplot(demo_df_biplot)


```

Angles between vectors in biplots tell us about correlations. From this biplot, we can observe that flu shot coverage in 2021 is mostly correlated to the high school education attainment rate in states. Since the household poverty rate forms a large angle with flu shot coverage rate, it is (relatively strongly) negatively correlated with flu shot coverage in 2021. Notice that child_ratio is also similarly negatively correlated with flu shot coverage, but we decided to experiment more on household poverty rate in the next section because there are more states that lie near the household poverty rate axis.

We can also observe state clusters in this graph: states like New Mexico, Alabama, and Kentucky lies at the negative flu shot coverage axis and positive household poverty rate axis, indicating that these states associated with high household poverty rate have less flu vaccination coverage; while for states like Colorado, New Jersey, and Hawaii lies at the positive axis of coverage and negative axis of household poverty rate, meaning these states have low poverty rate and high flu vaccinations coverage in 2021.

In conclusion, we sort out two most important factors that are correlated, one positively (high school education attainment rate) and one negatively (household poverty rate), to flu vaccination coverage in 2021. Next, we will plot these two factors alongside flu vaccination coverage in 2021 to better illustrate the pattern.


### Cleveland Dotplot of Most Important Factors

Again we use demo_df to plot the two factors mentioned above, with data normalized for better visualization.


```{r}

demo_df %>%
  select(c(state, flu_shot_coverage_2021, high_school_education_ratio, household_poverty_rate)) %>%
  mutate(across(where(is.numeric), ~round((.x-mean(.x))/sd(.x), 2))) %>%
  gather(key='type',value='percentage',flu_shot_coverage_2021, high_school_education_ratio, household_poverty_rate) %>%
  ggplot() +
    geom_point(aes(x=percentage, y=fct_reorder2(state,type=='flu_shot_coverage_2021',percentage,.desc=FALSE), color = type)) +
    ggtitle("Flu Coverage, Education, and Poverty Rates in the US") +
    ylab("") +
    theme_linedraw()+
  scale_color_colorblind(limits = c("flu_shot_coverage_2021", "high_school_education_ratio","household_poverty_rate"), 
                         labels=c("2021 flu vaccination coverage rate","high school education attainment rate","household poverty rates"))



```

As flu vaccination coverage rate increases, we see a decreasing pattern in the household poverty rate, or the blue dots; we can also see an increasing pattern in high school education attainment rate, or the orange dots. This confirms our conclusion made in the previous section. We will do our d3 interactive component based on this key finding.

## Time Series Comparison of Nationwide New COVID Cases with Flu Vaccination Coverage

```{r}
covid2 <- read.csv("data/raw/United_States_COVID-19_Cases.csv")

covid2 <- covid2[-which(covid2$tot_cases == 0 |is.na(covid2$tot_cases)),]
covid2 <- covid2 %>% dplyr::select(submission_date, state, new_case)
covid_time2 <- group_by(covid2,submission_date)
new_cases <- summarize(covid_time2, sum(new_case))
new_cases <- rename(new_cases, new_covid_case='sum(new_case)')
new_cases$submission_date <- as.Date(new_cases$submission_date, format = "%m/%d/%Y")
new_cases <- arrange(new_cases,submission_date)

library(scales)

g<-ggplot(new_cases, aes(submission_date, new_covid_case)) + 
  geom_smooth(method = "loess", span = .05, se = FALSE)+
  scale_x_date(limits = c(as.Date("2018-01-01"),as.Date("2021-12-01")))+
  scale_y_continuous(labels = scales::label_number_si())+
  labs(y="Count", title="Nationalwide New Covid Cases")+
  scale_color_colorblind()
  
coverage_rate <- rename(us_by_year, estimation='Estimate....',record_date='ym')
coverage_rate$difference_with_previous_month <- append(NA,diff(coverage_rate$estimation))
coverage_rate$difference_with_previous_month[coverage_rate$difference_with_previous_month<0]<-0
coverage_rate$record_date <- as.Date(coverage_rate$record_date)


# f<-ggplot(coverage_rate, aes(record_date, difference_with_previous_month)) + 
#   geom_smooth(method = "loess", span = .1, se = FALSE)+
#   scale_x_date(limits = c(as.Date("2018-01-01"),as.Date("2021-12-01")))+
#   labs(y="Percentage increase", title="Increase in Nationalwide Flu Vax Coverage Compared to Previous Months (%)")+
#   scale_color_colorblind()


coverage_rate$record_date <- as.Date(coverage_rate$record_date)


h<-ggplot(coverage_rate, aes(record_date, estimation)) + 
  geom_smooth(method = "loess", span = .1, se = FALSE)+
  scale_x_date(limits = c(as.Date("2018-01-01"),as.Date("2021-12-01")))+
  labs(y="Coverage Rate", title = "Nationalwide Flu Vaccination Coverage Rate (%)")+
  scale_color_colorblind()

plot_grid(g,h, nrow=2,align = "v")
```




```{r}

# library(choroplethr)
# 
# choropleth_df <-
#   demo_df %>%
#     select(c(state, household_poverty_rate)) %>%
#     mutate(household_poverty_rate = as.numeric(household_poverty_rate)) %>%
#     filter(state != "District of Columbia") %>%
#     transmute(region = tolower(`state`),
#            value =  household_poverty_rate)
# 
# states <- state_choropleth(choropleth_df,
#                  title = "Household Poverty Rate, 2021",
#                  legend = "Percent")
# 
# # remove state abbreviation labels
# layer_no <- grep("GeomText", sapply(states$layers, function(x) class(x$geom)[1]))
# states$layers[[layer_no]] <- NULL
# 
# states

```

```{r}


# us_by_year %>%
#   filter(Season.Survey.Year == "2021-22") %>%
#   ggplot(aes(factor(Month), Estimate....)) +
#     geom_line(group = 1) +
#     # scale_x_date(limits = c(as.Date("2012-02-01"), as.Date("2014-12-31")),  
#     #     date_breaks = "6 months", date_labels = "%b %Y") 
#     # scale_x_date(date_breaks = "years" , date_labels = "%Y") + 
#     xlab("Month") + 
#     ylab("Percent Coverage") +
#     ggtitle("Flu Shot Coverage, 2021 to 2022")


```
